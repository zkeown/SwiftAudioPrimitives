# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

SwiftRosa is a modular Swift/Metal port of [librosa](https://librosa.org/) for iOS and macOS. It provides production-grade audio DSP with GPU acceleration via Metal, enabling ML audio applications like music source separation on Apple devices.

## Build Commands

```bash
# Build
swift build

# Run all tests
swift test

# Run specific test target
swift test --filter SwiftRosaCoreTests

# Run validation tests (compare against librosa reference data)
swift test --filter "Validation"

# Run a single test class or method
swift test --filter "STFTTests"
swift test --filter "STFTTests/testBasicSTFT"

# Run benchmarks
swift test --filter SwiftRosaBenchmarks

# Run real audio validation (requires MUSDB18-HQ dataset setup)
swift test --filter RealAudioValidation

# Generate documentation
swift package generate-documentation --target SwiftRosa
```

## Package Architecture

The package uses a tiered dependency structure:

```
SwiftRosa (Umbrella - re-exports all)
    |
SwiftRosaML (Tier 3 - CoreML, source separation)
    |
SwiftRosaStreaming (Tier 2.5 - real-time processing)
    |
SwiftRosaAnalysis + SwiftRosaEffects + SwiftRosaNN (Tier 2)
    |
SwiftRosaCore (Tier 1 - STFT, Mel, Windows, Metal)
```

**Module placement guide:**
- `SwiftRosaCore`: Foundation DSP (STFT, Mel, Windows, Metal engine)
- `SwiftRosaAnalysis`: Onset, pitch, rhythm, VAD
- `SwiftRosaEffects`: CQT, MFCC, Chromagram, resampling, HPSS
- `SwiftRosaStreaming`: Real-time ring buffer processing
- `SwiftRosaML`: CoreML integration, audio file I/O
- `SwiftRosaNN`: LSTM/GRU layers with Metal acceleration

## Key Implementation Details

### Metal GPU Acceleration
- Metal shaders are compiled via `MetalCompilerPlugin` (custom SPM build tool plugin)
- GPU acceleration helps for large FFT sizes (>4096) and batch processing
- CPU (vDSP) is faster for small transforms and low-latency streaming
- Components accept `useGPU: Bool` parameter to toggle acceleration
- `MetalEngine` uses a buffer pool to reduce allocation overhead

### Librosa Compatibility
- Default parameters match librosa defaults
- Mel filterbank uses Slaney formula (not HTK) by default
- STFT uses centered frames with reflect padding
- Test signal generation uses Double precision internally (matches numpy float64)

### Validation Testing
- Reference data generated by `scripts/generate_reference_data.py` using librosa
- Tolerances defined in `Tests/SwiftRosaCoreTests/ValidationTolerances.swift`
- Tolerance tiers: Exact (1e-8) -> FFT (1e-6) -> Linear (1e-5) -> Log-domain (1e-4) -> Iterative (5%)

### Test Signal Generation
Use `TestSignalGenerator` (in ValidationTolerances.swift) for consistent test signals:
- `.sine(frequency:)`, `.multiTone()`, `.chirp()`, `.whiteNoise()`
- Uses Double precision internally to avoid Float32 artifacts

## Scripts

```bash
# Generate librosa reference data (requires: pip install librosa numpy scipy)
python scripts/generate_reference_data.py

# Check API coverage vs librosa
python scripts/check_api_coverage.py --report api_coverage.md

# Generate real audio reference (requires MUSDB18-HQ)
python scripts/generate_real_audio_reference.py --musdb-path ~/datasets/musdb18hq
```

## Code Style

- 4-space indentation, 120 character line limit
- Use `///` documentation comments for all public API
- Match librosa function names where applicable (e.g., `stft`, `melSpectrogram`)
- Use `@inlinable` for hot-path functions
- Prefer vDSP operations over manual loops
